<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.moirai.alloc.gantt.query.mapper.TaskQueryMapper">
    <select id="findTasks" resultType="com.moirai.alloc.gantt.query.dto.projection.TaskProjection">
        SELECT
            t.task_id AS taskId,
            t.milestone_id AS milestoneId,
            u.user_name AS userName,
            t.task_category AS taskCategory,
            t.task_name AS taskName,
            t.task_description AS taskDescription,
            t.task_status AS taskStatus,
            t.created_at AS createdAt,
            t.updated_at AS updatedAt,
            t.start_date AS startDate,
            t.end_date AS endDate,
            t.is_completed AS isCompleted,
            t.is_deleted AS isDeleted
        FROM task t
        JOIN milestone m ON m.milestone_id = t.milestone_id
        LEFT JOIN users u ON u.user_id = t.user_id
        WHERE m.project_id = #{projectId}
          AND t.is_deleted = false
        <if test="assigneeNames != null and assigneeNames.size() > 0">
            AND u.user_name IN
            <foreach collection="assigneeNames" item="name" open="(" separator="," close=")">
                #{name}
            </foreach>
        </if>
        <if test="status != null">
            AND t.task_status = #{status}
        </if>
        <if test="startDate != null">
            AND t.start_date &gt;= #{startDate}
        </if>
        <if test="endDate != null">
            AND t.end_date &lt;= #{endDate}
        </if>
        <if test="taskCategories != null and taskCategories.size() > 0">
            AND t.task_category IN
            <foreach collection="taskCategories" item="category" open="(" separator="," close=")">
                #{category}
            </foreach>
        </if>
        <if test="periods != null and periods.size() > 0">
            AND (
            <foreach collection="periods" item="period" separator=" OR ">
                <choose>
                    <when test="period == 'OVERDUE'">
                        t.end_date &lt; CURDATE()
                    </when>
                    <when test="period == 'D7'">
                        DATEDIFF(t.end_date, CURDATE()) BETWEEN 0 AND 7
                    </when>
                    <when test="period == 'D14'">
                        DATEDIFF(t.end_date, CURDATE()) BETWEEN 8 AND 14
                    </when>
                    <when test="period == 'D21'">
                        DATEDIFF(t.end_date, CURDATE()) BETWEEN 15 AND 21
                    </when>
                    <otherwise>
                        1 = 0
                    </otherwise>
                </choose>
            </foreach>
            )
        </if>
        ORDER BY t.start_date ASC, t.task_id ASC
    </select>

    <select id="findTaskById" resultType="com.moirai.alloc.gantt.query.dto.projection.TaskProjection">
        SELECT
            t.task_id AS taskId,
            t.milestone_id AS milestoneId,
            u.user_name AS userName,
            t.task_category AS taskCategory,
            t.task_name AS taskName,
            t.task_description AS taskDescription,
            t.task_status AS taskStatus,
            t.created_at AS createdAt,
            t.updated_at AS updatedAt,
            t.start_date AS startDate,
            t.end_date AS endDate,
            t.is_completed AS isCompleted,
            t.is_deleted AS isDeleted
        FROM task t
        JOIN milestone m ON m.milestone_id = t.milestone_id
        LEFT JOIN users u ON u.user_id = t.user_id
        WHERE m.project_id = #{projectId}
          AND t.task_id = #{taskId}
          AND t.is_deleted = false
    </select>

    <select id="findTasksByMilestone" resultType="com.moirai.alloc.gantt.query.dto.projection.TaskProjection">
        SELECT
            t.task_id AS taskId,
            t.milestone_id AS milestoneId,
            u.user_name AS userName,
            t.task_category AS taskCategory,
            t.task_name AS taskName,
            t.task_description AS taskDescription,
            t.task_status AS taskStatus,
            t.created_at AS createdAt,
            t.updated_at AS updatedAt,
            t.start_date AS startDate,
            t.end_date AS endDate,
            t.is_completed AS isCompleted,
            t.is_deleted AS isDeleted
        FROM task t
        JOIN milestone m ON m.milestone_id = t.milestone_id
        LEFT JOIN users u ON u.user_id = t.user_id
        WHERE m.project_id = #{projectId}
          AND t.milestone_id = #{milestoneId}
          AND t.is_deleted = false
        ORDER BY t.start_date ASC, t.task_id ASC
    </select>
</mapper>
